## 谈谈悲观锁和乐观锁

前几天和同学一起讨论的时候针对悲观锁和乐观锁聊了几个概念并且打了几个很有趣的比方，这里我梳理一下，给大家一起看看。如有错误欢迎大佬指正。



#### 首先我们要了解大概的基础概念



##### 什么是悲观锁和乐观锁：

> 在生活中类比：乐观锁就是对应觉得所有的事物都会往好的方向发展，所以不会对未发生的事情放太多的心思，但是悲观锁不同，他会觉得所有的事情都会出现自己没有考虑到的意外，所以会额外的花心思来注意这件事的发展顺序。
>
> ​		我个人觉得，无论是悲观锁和乐观锁，都是我们自己定义出来的概念，不是说这个仅仅存在于数据库层面，在其他的方面都有类似的概念（例如synchronized和CAS）。注意跳脱出数据库提供的锁机制。



##### 悲观锁：

​		顾名思义，就是很悲观，会认为无论做什么事情都会有意外的发生，换言之就是他在做一件事情的时候总是会担心有其他人会来干扰他。比如他在敲代码的时候，总是觉得产品会在背后说你写的需求需要更改，这是很恐怖的事情，怎么办呢？他找一个房间讲自己反锁在里面，没有敲完代码谁都不能进入到这个房间。在自己编写代码的时候，强制锁定需求，无法通过外部来变更需求。



##### 乐观锁：

​		乐观锁现在就是：会认为所有的事情都按照预定的安排发生，不会发生其他的意外。只是在需要使用的时候判断是不是和上次的一样。举个栗子：在开发的过程中，不用去考虑产品给出来的需求会有变更。只需要去设计好然后直接编程不需要害怕产品站在你背后说：这个需求可能有变更，你看看改成这样行不行？

​		没有需求变更，这真是程序员向往的生活啊。



如果你还没有理解，没关系我这里再举一个栗子。

##### 打个很简单的比方：

​		假设有一个深圳的舔狗小斌，他特别喜欢一个北京的漂亮女生小B，在他的不懈努力的情况下，从众多的追随者之中脱颖而出，成功的成为了小B的男朋友。这是一个前提。

​		因为他们是异地恋，同时他也知道小B有很多人喜欢。他十分的害怕在他不在小B身边的时候，他的情敌将他的女朋友抢走，从而被迫分手。所以他在他们刚开始谈恋爱的时候就选择离开深圳去北京重新发展，于女友小B一起生活。

> ​		对于小斌的行为来讲，他于女朋友一起之后一直担心不在小B身边的时候会发生自己不乏预料的事情。所以选择离开深圳前往北京，选择了一直陪在女朋友身边。这就是一种悲观锁的思想，时时刻刻呆在女朋友身边，发生什么时候不给其他男人嘘寒问暖的机会。

​	

​		如果小斌是一个乐观积极向上的人，他觉得女朋友不会遇到什么意外，他们会按照正常的轨迹发展下去。所以他选择了继续在深圳奋斗。天天在手机上和女朋友聊聊天也挺不错，这是碰到放假休息的时候，他就去北京找女朋友，下飞机遇到小B后会看小B是不是还是自己的女朋友。

​		如果一到北京发现女朋友身边有其他的男人，没错就是被绿了， 如果真的喜欢的话，就重新追求咯，知道小B重新答应做自己的女朋友。毕竟要想生活过得去是吧。

​		要是上述事件没有发生，小B依然爱你。这当然是甜甜蜜蜜的该干嘛干嘛。想吃饭啊，看电影啊，不要想歪了。

> ​		对于乐观小斌来讲，他不会在深圳的时候去担心说女朋友跟别人跑了这种情况。他要注意的点是什么，就是他去北京的时候只要确保小B还是自己的女朋友就可以了。



​		这里其实我们会发现存在一个问题，如果中间的事件小B碰上了自己特别喜欢的一个人小A，并且在你不知情的情况下和小A在一起了一段时间，但是这段时间里面小B觉得和小A在一起没有和小斌好，遂和小A分开了。注意这段经历小斌是不知道了。所以这也导致了小斌来到北京的时候小B确实是小斌的女朋友，但是小B的感情经历也确实发生了改变。

​		这也就是CAS著名的ABA问题。要解决这个问题的话也很简单，只需要给小B的情感生活打上一个备注，也就是版本号。注明现在小B经历的是第几段感情经历。小斌作为小B的第二任男友，来到北京后还发现，小B的感情经历变成了第五段，这不就是恶意刷级嘛？小斌也不是傻子，肯定发现了，具体怎么做，这个就看小斌的想法了。

​		其实你还对synchronized和CAS还有一点概念的话，就会知道上面例子就是针对syn和CAS来描述的。之后会针对synchronized深入的讲解一下他在JDK1.6所发生巨大改变。以至于他不再是重量级锁。



